# Fusion Chaos - 2.6 Visual Effects

## 2.6 视觉特效系统 (Visual Effects System)

该系统通过 `MagneticEffectMixin` 提供极简且高效的视觉反馈，包括引力线和连接脉冲。

### 1. 引力线条 (Attraction Lines)

在吸引源（目标网格位）和被吸引方块之间绘制动态线条，增强“掌控感”。

- **透明度**: 随距离线性衰减 (`1.0 - Distance / Radius`)。
- **线宽**: 固定为 `1.0`。
- **颜色**: 纯白 (`#FFFFFF`)。

### 2. 连接脉冲 (Connection Impact Pulse)

当方块成功融合到集群时，在接触面上触发一个线性的扩散脉冲，模拟物理撞击感。

#### 表现行为
- **触发点**: 两个方块接触面的中心。
- **方向**: 与接触面平行（水平连接产生垂直脉冲，垂直连接产生水平脉冲）。
- **扩散**: 线条长度从 `20.0` (cellSize) 迅速扩张至 `40.0`。
- **衰减**:
  - 透明度从 `1.0` 降至 `0.0`。
  - 线宽从 `2.0` 降至 `0.5`。
- **时长**: `0.4` 秒。

### 3. 技术实现

#### MagneticEffectMixin
位于 `lib/components/mixins/magnetic_effect_mixin.dart`。

```dart
mixin MagneticEffectMixin on PositionComponent {
  // 核心方法
  void drawAttractionLine(Canvas canvas, Vector2 start, Vector2 end, double strength);
  void addImpactPulse(Vector2 center, bool isVertical, {double duration});
  void updatePulses(double dt);
  void renderPulses(Canvas canvas);
}
```

#### 集成流程 (以 Player 为例)
1. **每一帧更新**: 调用 `updatePulses(dt)` 推进动画进度。
2. **渲染层级**: 在 `render` 中调用 `renderPulses(canvas)`。为了视觉清晰，脉冲通常在引力线之后绘制。
3. **碰撞触发**: 在 `attachSquare` 成功时，计算接触面位置并调用 `addImpactPulse`。

### 4. 调试支持
在调试面板（Debug Panel）中提供了以下参数实时调整：
- **Show Lines**: 开关引力线条显示。
- **Show Pulses**: 开关连接脉冲显示。
- **Pulse Duration**: 调整脉冲持续时间（0.1s - 2.0s）。

### 5. 性能考量
- **零分配 (Zero Allocation)**: 动画状态由内部列表管理，过期自动移除。
- **轻量绘图**: 仅使用 `canvas.drawLine`，无位图或复杂路径运算。
- **批处理友好**: 适合在大量组件同时发生融合时保持帧率稳定。
