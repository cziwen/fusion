# Fusion Chaos - 2.6 Visual Effects

## 2.6 视觉特效系统 (Visual Effects System)

该系统通过 `MagneticEffectMixin` 提供极简且高效的视觉反馈，包括引力场特效和连接脉冲。

### 1. 引力场特效 (Attraction Field Effects)

在吸引源（目标网格位）和被吸引方块之间展示动态效果，模拟引力场。系统支持多种视觉风格，通过 `AttractionStyle` 进行切换。

#### 视觉风格 (Styles)
- **Streaks (场线流影)**: 默认风格。在被吸引方块周围产生短促的、指向目标点的流线，模拟能量流向吸引源的效果，指引性较弱但氛围感强。
- **Waves (重力波纹)**: 在两者之间绘制若干段垂直于连线方向的短弧，弧线从方块向目标点移动，模拟波浪式的吸引力，视觉感官柔和且具有动感。
- **Solid (实线)**: 传统的直线连接，指引性最强，适合调试或需要强反馈的场景。
- **None**: 不显示任何引力特效。

#### 动态表现
- **透明度衰减**: 随距离线性衰减 (`1.0 - Distance / Radius`)。
- **运动动画**: 波纹和流线随时间沿引力轴移动。
- **线宽动态**: 波纹宽度和流线粗细随运动进度变化（通常在接近目标时变淡变细）。

### 2. 连接脉冲 (Connection Impact Pulse)

当方块成功融合到集群时，在接触面上触发一个线性的扩散脉冲，模拟物理撞击感。

#### 表现行为
- **触发点**: 两个方块接触面的中心。
- **方向**: 与接触面平行（水平连接产生垂直脉冲，垂直连接产生水平脉冲）。
- **扩散**: 线条长度从 `24.0` 迅速扩张至 `50.0`。
- **衰减**:
  - 透明度从 `1.0` 降至 `0.0`。
  - 线宽从 `2.5` 降至 `0.6`。
- **时长**: `0.4` 秒。

### 3. 技术实现

#### MagneticEffectMixin
位于 `lib/components/mixins/magnetic_effect_mixin.dart`。

```dart
enum AttractionStyle { none, solid, waves, streaks }

mixin MagneticEffectMixin on PositionComponent {
  // 核心方法
  void drawAttractionEffect(Canvas canvas, Vector2 start, Vector2 end, double strength, {AttractionStyle style});
  void addImpactPulse(Vector2 center, bool isVertical, {double duration});
  void updatePulses(double dt);
  void renderPulses(Canvas canvas);
}
```

#### 集成流程 (以 Player 为例)
1. **每一帧更新**: 调用 `updatePulses(dt)` 推进动画进度（包括引力场动画所需的时间计数）。
2. **渲染层级**: 在 `render` 中遍历 `_activeAttractionTargets` 并调用 `drawAttractionEffect`。脉冲通常在最后绘制以确保层级最高。
3. **碰撞触发**: 在 `attachSquare` 成功时，计算接触面位置并调用 `addImpactPulse`。

### 4. 调试支持
在调试面板（Debug Panel）中提供了以下参数实时调整：
- **Show Lines**: 开关引力特效显示。
- **Gravity Style**: 切换特效风格 (Waves/Streaks/Solid/None)。
- **Show Pulses**: 开关连接脉冲显示。
- **Pulse Duration**: 调整脉冲持续时间（0.1s - 2.0s）。

### 5. 性能考量
- **零分配 (Zero Allocation)**: 动画状态（如时间计数）在 Mixin 中维护，波纹和流线的计算在渲染时即时完成。
- **轻量绘图**: 使用 `canvas.drawLine` 和简单的 `Path`，不涉及复杂的图形运算或位图。
- **批处理友好**: 适合在大量组件同时被吸引时保持流畅。
