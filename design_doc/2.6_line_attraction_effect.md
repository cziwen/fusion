# Fusion Chaos - 2.6 Visual Effects

## 2.6 视觉特效系统 (Visual Effects System)

该系统通过 `MagneticEffectMixin` 提供极简且高效的视觉反馈，包括引力场特效和连接脉冲。

### 1. 引力场特效 (Attraction Field Effects)

在吸引源（目标网格位）和被吸引方块之间展示动态效果，模拟引力场。系统支持多种视觉风格，通过 `AttractionStyle` 进行切换。

#### 视觉风格 (Styles)
- **Streaks (场线流影)**: 默认风格。在被吸引方块周围产生短促的、指向目标点的流线，模拟能量流向吸引源的效果，指引性较弱但氛围感强。
- **Waves (重力波纹)**: 在两者之间绘制若干段垂直于连线方向的短弧，弧线从方块向目标点移动，模拟波浪式的吸引力，视觉感官柔和且具有动感。
- **Solid (实线)**: 传统的直线连接，指引性最强，适合调试或需要强反馈的场景。
- **None**: 不显示任何引力特效。

#### 动态表现
- **透明度衰减**: 随距离线性衰减 (`1.0 - Distance / Radius`)。
- **运动动画**: 波纹和流线随时间沿引力轴移动。
- **线宽动态**: 波纹宽度和流线粗细随运动进度变化（通常在接近目标时变淡变细）。

### 2. 连接脉冲 (Connection Impact Pulse)

当方块成功融合到集群时，在接触面上触发一个线性的扩散脉冲，模拟物理撞击感。

#### 表现行为
- **触发点**: 两个方块接触面的中心。
- **方向**: 与接触面平行（水平连接产生垂直脉冲，垂直连接产生水平脉冲）。
- **扩散**: 线条长度从 `24.0` 迅速扩张至 `50.0`。
- **衰减**:
  - 透明度从 `1.0` 降至 `0.0`。
  - 线宽从 `2.5` 降至 `0.6`。
- **时长**: `0.4` 秒。

### 3. 核心方块特效 (Core Block Effects)

为了增强游戏的核心仪式感，核心方块使用了 `CoreEffectMixin` (位于 `lib/components/mixins/core_effect_mixin.dart`) 提供专属的动态视觉。

#### 背景特效 (Background Effects)
- **Core Glow (核心辉光)**: 在方块后方渲染一个半径为 `size.x * 0.8` 的白色径向渐变辉光，使用 `MaskFilter.blur` 实现柔和的能量场感。
- **Pulsing Aura Rings (脉冲光环)**: 两个交替出现的圆角矩形环，随时间向外扩散并淡出，模拟核心的“呼吸”频率。
- **Core Breathing (本体呼吸)**: 核心白色方块自身的透明度在 `0.8` 到 `1.0` 之间随正弦波动，使其看起来更具生命力。

#### 前景特效 (Foreground Effects)
- **Energy Particles (能量粒子)**: 核心边缘会持续产生细小的白色粒子，以随机速度向外发散，增加核心的活性。
- **Scanning Pulse Line (扫描线)**: 一条水平线在核心区域内往复扫描，增加精密电子/数字世界的氛围。

### 4. 消除吸积特效 (Match Absorption Effect / Black Hole)

当方块满足消除条件（如五连珠或金字塔）时，触发一个“黑洞”式的吸积动画，为用户提供清晰的消除反馈。

#### 表现行为
- **质心计算**: 计算所有参与消除方块的几何中心点（Centroid）。
- **中央脉冲 (Implosion)**: 在质心处绘制一个向外扩散并淡出的圆环，模拟内爆产生的能量波动。
- **残影飞入 (Square Absorption)**: 
  - 在每个被消除方块的原始网格位置产生一个白色残影。
  - 残影在动画时间内线性向质心移动，同时尺寸从 `20x20` 缩小至 `0x0`。
  - 透明度随运动进度从 `0.6` 降至 `0.0`。
- **时长**: `0.6` 秒。

### 5. 技术实现

#### MagneticEffectMixin
位于 `lib/components/mixins/magnetic_effect_mixin.dart`。

```dart
enum AttractionStyle { none, solid, waves, streaks }

mixin MagneticEffectMixin on PositionComponent {
  // 核心方法
  void drawAttractionEffect(Canvas canvas, Vector2 start, Vector2 end, double strength, {AttractionStyle style});
  void addImpactPulse(Vector2 center, bool isVertical, {double duration});
  void addMatchAbsorptionEffect(List<Vector2> localPositions, {double duration});
  void updatePulses(double dt);
  void renderPulses(Canvas canvas);
}
```

#### CoreEffectMixin
位于 `lib/components/mixins/core_effect_mixin.dart`。

```dart
mixin CoreEffectMixin on PositionComponent {
  void updateCoreEffects(double dt);
  void renderCoreBackgroundEffects(Canvas canvas);
  void renderCoreForegroundEffects(Canvas canvas);
}
```

### 5. 集成流程 (以 Player 为例)
1. **每一帧更新**: 调用 `updatePulses(dt)` 和 `updateCoreEffects(dt)` 推进动画进度。
2. **渲染层级**: 
    - 首先调用 `renderCoreBackgroundEffects`。
    - 然后调用 `super.render` 绘制基础白色方块。
    - 接着调用 `renderCoreForegroundEffects`。
    - 最后在遍历吸引目标时调用 `drawAttractionEffect`。
3. **碰撞触发**: 在 `attachSquare` 成功时，计算接触面位置并调用 `addImpactPulse`。

### 6. 调试支持
在调试面板（Debug Panel）中提供了以下参数实时调整：
- **Show Lines**: 开关引力特效显示。
- **Gravity Style**: 切换特效风格 (Waves/Streaks/Solid/None)。
- **Show Pulses**: 开关连接脉冲显示。
- **Pulse Duration**: 调整脉冲持续时间（0.1s - 2.0s）。

### 7. 性能考量
- **零分配 (Zero Allocation)**: 动画状态（如时间计数、粒子池）在 Mixin 中维护，减少垃圾回收压力。
- **轻量绘图**: 使用 `canvas.drawCircle`, `canvas.drawRRect`, `canvas.drawLine` 等基础指令，不涉及复杂的图形运算或位图。
- **分层渲染**: 通过将特效拆分为背景和前景，确保核心方块的形状在视觉上始终清晰。
